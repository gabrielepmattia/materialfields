def buildVersionCode() {
    // Increments the versionName
    def (String major, String minor, String patch) = materialfieldsVersionName.toLowerCase().replaceAll('-', '').tokenize('.')
    Integer patch_int = patch.toInteger() + 1
    materialfieldsVersionName = major + "." + minor + "." + patch_int

    // Increments the versionCode
    materialfieldsVersionCode = (materialfieldsVersionCode.toInteger() + 1).toString()

    // Write settings
    def versionPropsFile = file("./gradle.properties")
    Properties versionProps = new Properties()
    versionProps.load(new FileInputStream(versionPropsFile))
    versionProps["materialfieldsVersionName"] = materialfieldsVersionName
    versionProps["materialfieldsVersionCode"] = materialfieldsVersionCode
    versionProps.store(versionPropsFile.newWriter(), null)
}

/*
 * Materialfields
 * Copyright (c) 2020 by gabrielepmattia, All rights reserved.
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3.0 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library.
 */

task updateVersion {
    doLast {
        println '\n################## Version Update ##################'
        println '# From version:\t ' + materialfieldsVersionName + ' (' + materialfieldsVersionCode + ')'
        buildVersionCode()
        println '# To version:\t ' + materialfieldsVersionName + ' (' + materialfieldsVersionCode + ')'
        println '####################################################'
    }
}

configure(updateVersion) {
    group = 'versioning'
    description = 'Manage your project version'
}